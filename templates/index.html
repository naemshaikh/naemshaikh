<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MrBlack Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* ‚îÄ‚îÄ PREMIUM GREY PALETTE ‚îÄ‚îÄ */
            --bg:          #0e0f11;          /* near-black with cool grey tint */
            --surface:     #161719;          /* header / input bar */
            --card:        #1c1d20;          /* cards */
            --card-hover:  #222427;
            --border:      rgba(180,185,200,0.10);
            --border-bright: rgba(180,185,200,0.28);

            /* Accent: warm silver-white for primary actions */
            --accent:      #c8ccd8;
            --accent-dim:  rgba(200,204,216,0.10);
            --accent-glow: rgba(200,204,216,0.18);

            /* Status colors ‚Äî slightly desaturated for the grey palette */
            --green:       #4de8a0;
            --green-dim:   rgba(77,232,160,0.10);
            --red:         #f05068;
            --red-dim:     rgba(240,80,104,0.10);
            --amber:       #e8a830;
            --amber-dim:   rgba(232,168,48,0.10);

            /* Text */
            --text:        #dde0ea;          /* primary text */
            --muted:       rgba(200,204,216,0.40);
            --subtle:      rgba(200,204,216,0.22);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* subtle noise texture overlay */
        body::before {
            content: '';
            position: fixed; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 0;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 18px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0; z-index: 20; position: relative;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .logo-icon {
            width: 34px; height: 34px;
            background: linear-gradient(135deg, #9aa0b4 0%, #c8ccd8 100%);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 800; color: #0e0f11;
            letter-spacing: -1px;
        }
        .brand-name { font-size: 17px; font-weight: 800; letter-spacing: -0.5px; color: var(--text); }
        .live-badge {
            font-size: 9px;
            background: rgba(77,232,160,0.08);
            color: var(--green);
            border: 1px solid rgba(77,232,160,0.25);
            padding: 2px 7px; border-radius: 20px;
            font-family: 'Space Mono', monospace;
        }
        .header-icons { display: flex; gap: 18px; color: var(--muted); font-size: 15px; }
        .header-icons i { cursor: pointer; transition: color 0.2s; }
        .header-icons i:active { color: var(--accent); }

        /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
        .tabs {
            display: flex;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0; position: relative; z-index: 10;
        }
        .tab {
            flex: 1; padding: 10px; text-align: center;
            font-size: 12px; font-weight: 600; color: var(--muted);
            cursor: pointer; border-bottom: 2px solid transparent;
            transition: all 0.2s; letter-spacing: 0.5px;
        }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
        .panel { display: none; flex: 1; overflow: hidden; flex-direction: column; position: relative; z-index: 1; }
        .panel.active { display: flex; }

        /* ‚îÄ‚îÄ DASHBOARD PANEL ‚îÄ‚îÄ */
        .dashboard-scroll {
            flex: 1; overflow-y: auto; padding: 14px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .dashboard-scroll::-webkit-scrollbar { display: none; }

        /* Stats row */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 10px; text-align: center;
            transition: border-color 0.2s;
        }
        .stat-card:hover { border-color: var(--border-bright); }
        .stat-label { font-size: 9px; font-family: 'Space Mono', monospace; color: var(--muted); letter-spacing: 1px; margin-bottom: 5px; }
        .stat-val { font-size: 15px; font-weight: 700; font-family: 'Space Mono', monospace; }
        .stat-sub { font-size: 9px; color: var(--muted); margin-top: 2px; }

        /* Mode toggle */
        .mode-toggle {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 10px 14px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .mode-label { font-size: 12px; font-weight: 600; color: var(--muted); }
        .toggle-btns { display: flex; gap: 6px; }
        .mode-btn {
            padding: 5px 14px; border-radius: 8px; font-size: 11px; font-weight: 700;
            border: 1px solid var(--border); background: transparent; color: var(--muted);
            cursor: pointer; font-family: 'Space Mono', monospace; transition: all 0.2s;
        }
        .mode-btn.active-paper {
            background: var(--green-dim); color: var(--green);
            border-color: rgba(77,232,160,0.45);
        }
        .mode-btn.active-real {
            background: var(--red-dim); color: var(--red);
            border-color: rgba(240,80,104,0.45);
        }

        /* Pairs */
        .section-title {
            font-size: 11px; font-family: 'Space Mono', monospace;
            color: var(--muted); letter-spacing: 1.5px; margin-bottom: 8px;
        }
        .pairs-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
        .pairs-scroll::-webkit-scrollbar { display: none; }
        .pair-chip {
            flex-shrink: 0;
            background: var(--card); border: 1px solid var(--border);
            border-radius: 20px; padding: 6px 14px; font-size: 11px;
            font-family: 'Space Mono', monospace; white-space: nowrap;
            cursor: pointer; transition: all 0.15s; color: var(--muted);
        }
        .pair-chip:active { border-color: var(--accent); color: var(--accent); }
        .pair-chip.hot { border-color: rgba(232,168,48,0.35); color: var(--amber); }

        /* Positions */
        .position-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 12px 14px;
            display: flex; align-items: center; justify-content: space-between;
            transition: border-color 0.2s;
        }
        .position-card:hover { border-color: var(--border-bright); }
        .pos-token { font-weight: 700; font-size: 13px; }
        .pos-meta { font-size: 10px; color: var(--muted); margin-top: 2px; font-family: 'Space Mono', monospace; }
        .pos-pnl { text-align: right; font-family: 'Space Mono', monospace; font-weight: 700; }
        .pos-pnl .pct { font-size: 15px; }
        .pos-pnl .usd { font-size: 10px; color: var(--muted); }

        /* Action buttons */
        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .action-btn {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; padding: 12px; font-size: 12px; font-weight: 700;
            color: var(--text); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.15s; font-family: 'Syne', sans-serif;
        }
        .action-btn:active { transform: scale(0.97); border-color: var(--accent); }

        /* ‚îÄ‚îÄ CHAT PANEL ‚îÄ‚îÄ */
        .chat-panel {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
        }

        .messages {
            flex: 1; overflow-y: auto; padding: 14px 14px 8px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .messages::-webkit-scrollbar { width: 3px; }
        .messages::-webkit-scrollbar-thumb { background: var(--subtle); border-radius: 10px; }

        .msg-row { display: flex; }
        .msg-row.user { justify-content: flex-end; }
        .msg-row.bot  { justify-content: flex-start; }

        .bubble {
            max-width: 82%; padding: 10px 14px;
            font-size: 13px; line-height: 1.55;
            border-radius: 18px; word-break: break-word;
        }
        .bubble.user {
            background: linear-gradient(135deg, #242629, #1c1d20);
            border: 1px solid rgba(180,185,200,0.18);
            border-bottom-right-radius: 5px;
            color: var(--text);
        }
        .bubble.bot {
            background: var(--card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 5px;
        }
        .bot-name {
            font-size: 9px; font-family: 'Space Mono', monospace;
            color: var(--accent); letter-spacing: 1px; margin-bottom: 4px;
            opacity: 0.7;
        }

        /* Typing */
        .typing-dots span {
            display: inline-block; width: 6px; height: 6px;
            background: var(--accent); border-radius: 50%; margin: 0 2px;
            animation: bounce 1.2s infinite; opacity: 0.5;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%,60%,100% { transform: translateY(0); opacity: 0.35; }
            30%          { transform: translateY(-5px); opacity: 1; }
        }

        /* Suggestions */
        .suggestions {
            padding: 6px 14px 6px;
            display: flex; gap: 6px; overflow-x: auto; flex-shrink: 0;
        }
        .suggestions::-webkit-scrollbar { display: none; }
        .suggestion {
            flex-shrink: 0; background: var(--card);
            border: 1px solid var(--border); border-radius: 20px;
            padding: 6px 12px; font-size: 11px; cursor: pointer;
            transition: all 0.15s; white-space: nowrap; color: var(--muted);
        }
        .suggestion:active { border-color: var(--accent); color: var(--accent); }

        /* ‚îÄ‚îÄ INPUT BAR ‚Äî fixed height, NOT pushed to bottom ‚îÄ‚îÄ */
        .input-bar {
            padding: 10px 14px 12px;           /* top / sides / bottom ‚Äî 12px bottom gap from screen edge */
            background: var(--surface);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }
        .input-row { display: flex; gap: 8px; align-items: center; }
        .chat-input {
            flex: 1;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 11px 18px;
            font-size: 13px; color: var(--text);
            font-family: 'Syne', sans-serif;
            outline: none; transition: border-color 0.2s;
            line-height: 1.4;
        }
        .chat-input:focus { border-color: rgba(200,204,216,0.40); }
        .chat-input::placeholder { color: var(--muted); }
        .send-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: linear-gradient(135deg, #8b91a8, #c8ccd8);
            border: none; color: #0e0f11; font-size: 15px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: transform 0.15s, opacity 0.15s;
        }
        .send-btn:active { transform: scale(0.88); opacity: 0.8; }

        /* ‚îÄ‚îÄ SCAN PANEL ‚îÄ‚îÄ */
        .scan-panel {
            flex: 1; overflow-y: auto; padding: 14px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .scan-panel::-webkit-scrollbar { display: none; }
        .scan-input-wrap {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 14px;
        }
        .scan-addr-input {
            width: 100%; background: var(--bg); border: 1px solid var(--border);
            border-radius: 10px; padding: 11px 14px; font-size: 12px;
            color: var(--text); font-family: 'Space Mono', monospace;
            outline: none; margin-bottom: 10px; transition: border-color 0.2s;
        }
        .scan-addr-input:focus { border-color: rgba(200,204,216,0.40); }
        .scan-btn {
            width: 100%; padding: 12px; background: var(--accent-dim);
            border: 1px solid var(--border-bright); border-radius: 10px;
            color: var(--accent); font-size: 13px; font-weight: 700;
            cursor: pointer; font-family: 'Syne', sans-serif; transition: all 0.2s;
        }
        .scan-btn:active { background: var(--accent-glow); }

        .checklist-grid { display: flex; flex-direction: column; gap: 6px; }
        .check-item {
            display: flex; align-items: center; gap: 10px;
            background: var(--card); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 12px;
        }
        .check-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; background: var(--muted); }
        .check-dot.pass { background: var(--green); box-shadow: 0 0 6px rgba(77,232,160,0.5); }
        .check-dot.fail { background: var(--red);   box-shadow: 0 0 6px rgba(240,80,104,0.5); }
        .check-dot.warn { background: var(--amber); }
        .check-text { font-size: 12px; flex: 1; }
        .check-badge {
            font-size: 9px; font-family: 'Space Mono', monospace;
            padding: 2px 7px; border-radius: 10px; letter-spacing: 0.5px;
        }
        .badge-pass { background: var(--green-dim); color: var(--green); }
        .badge-fail { background: var(--red-dim);   color: var(--red); }
        .badge-warn { background: var(--amber-dim); color: var(--amber); }

        /* Utility */
        .green  { color: var(--green);  }
        .red    { color: var(--red);    }
        .amber  { color: var(--amber);  }
        .silver { color: var(--accent); }
        .mono   { font-family: 'Space Mono', monospace; }
        .section-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 12px 14px;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <div class="logo-icon">MB</div>
            <div>
                <span class="brand-name">MrBlack</span>&nbsp;
                <span class="live-badge">‚óè LIVE</span>
            </div>
        </div>
        <div class="header-icons">
            <i class="fas fa-bell"></i>
            <i class="fas fa-cog"></i>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')"><i class="fas fa-chart-bar"></i> Dashboard</div>
        <div class="tab" onclick="switchTab('chat')"><i class="fas fa-robot"></i> Chat</div>
        <div class="tab" onclick="switchTab('scan')"><i class="fas fa-search"></i> Scan</div>
    </div>

    <!-- ===== DASHBOARD ===== -->
    <div class="panel active" id="panel-dashboard">
        <div class="dashboard-scroll">

            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">PAPER</div>
                    <div class="stat-val green" id="paperBal">1.87</div>
                    <div class="stat-sub">BNB</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">REAL</div>
                    <div class="stat-val red" id="realBal">0.00</div>
                    <div class="stat-sub">BNB</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">PNL 24H</div>
                    <div class="stat-val green" id="pnlVal">+12.4%</div>
                    <div class="stat-sub" id="pnlUsd">+$53.20</div>
                </div>
            </div>

            <div class="mode-toggle">
                <span class="mode-label">Trading Mode</span>
                <div class="toggle-btns">
                    <button class="mode-btn active-paper" id="btnPaper" onclick="setMode('paper')">PAPER</button>
                    <button class="mode-btn" id="btnReal" onclick="setMode('real')">REAL</button>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title">üî• HOT PAIRS ‚Äî BSC</div>
                <div class="pairs-scroll">
                    <div class="pair-chip hot" onclick="scanFromPair('CAKE')">CAKE/BNB üî•</div>
                    <div class="pair-chip" onclick="scanFromPair('XRP')">XRP/BNB</div>
                    <div class="pair-chip" onclick="scanFromPair('DOGE')">DOGE/BNB</div>
                    <div class="pair-chip hot" onclick="scanFromPair('PEPE')">PEPE/BNB üöÄ</div>
                    <div class="pair-chip" onclick="scanFromPair('WIF')">WIF/BNB</div>
                </div>
            </div>

            <div>
                <div class="section-title">üìÇ OPEN POSITIONS</div>
                <div class="checklist-grid" id="positionsList">
                    <div class="position-card">
                        <div>
                            <div class="pos-token">CAKE/BNB</div>
                            <div class="pos-meta">Entry: 0.0041 BNB ¬∑ Size: 0.18 BNB</div>
                        </div>
                        <div class="pos-pnl">
                            <div class="pct green">+8.3%</div>
                            <div class="usd">+$14.20</div>
                        </div>
                    </div>
                    <div class="position-card">
                        <div>
                            <div class="pos-token">PEPE/BNB</div>
                            <div class="pos-meta">Entry: 0.0000012 ¬∑ Size: 0.08 BNB</div>
                        </div>
                        <div class="pos-pnl">
                            <div class="pct red">-2.1%</div>
                            <div class="usd">-$4.10</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="font-size:11px; color:var(--muted);">Portfolio Exposure</span>
                    <span class="mono" style="font-size:11px;" id="exposureText">22% / 65%</span>
                </div>
                <div style="background:var(--bg); border-radius:20px; height:6px; overflow:hidden;">
                    <div id="exposureBar" style="height:100%; width:33.8%;
                        background:linear-gradient(90deg, #6b7285, #c8ccd8);
                        border-radius:20px; transition:width 0.5s;"></div>
                </div>
            </div>

            <div class="action-row">
                <button class="action-btn" onclick="goScan()">
                    <span class="silver"><i class="fas fa-search"></i></span> Scan Token
                </button>
                <button class="action-btn" onclick="prefillChat('Quick buy ')">
                    <span class="green"><i class="fas fa-bolt"></i></span> Quick Buy
                </button>
                <button class="action-btn" onclick="prefillChat('Close all positions')">
                    <span class="red"><i class="fas fa-times-circle"></i></span> Close All
                </button>
                <button class="action-btn" onclick="prefillChat('Paper trading balance')">
                    <span class="amber"><i class="fas fa-wallet"></i></span> Balance
                </button>
            </div>
        </div>
    </div>

    <!-- ===== CHAT ===== -->
    <div class="panel" id="panel-chat">
        <div class="chat-panel">
            <div class="messages" id="messages"></div>

            <div class="suggestions">
                <div class="suggestion" onclick="sendSuggestion('Paper trading balance kya hai?')">üìù Paper Balance</div>
                <div class="suggestion" onclick="sendSuggestion('Market trend kya hai aaj?')">üìä Market Trend</div>
                <div class="suggestion" onclick="sendSuggestion('Meri positions close karo')">‚ùå Close Positions</div>
                <div class="suggestion" onclick="sendSuggestion('Risk settings batao')">‚öôÔ∏è Risk Settings</div>
            </div>

            <!-- INPUT BAR ‚Äî stays just above device's safe area, not forced to very bottom -->
            <div class="input-bar">
                <div class="input-row">
                    <input id="chatInput" class="chat-input" type="text"
                        placeholder="Kuch bhi poocho..." autocomplete="off">
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SCAN ===== -->
    <div class="panel" id="panel-scan">
        <div class="scan-panel">
            <div class="scan-input-wrap">
                <div class="section-title" style="margin-bottom:10px;">üîç TOKEN SCANNER</div>
                <input id="scanAddr" class="scan-addr-input" type="text"
                    placeholder="Contract address 0x... paste karo">
                <button class="scan-btn" onclick="runScan()">
                    <i class="fas fa-search"></i> Scan Token
                </button>
            </div>

            <div id="scanResult" style="display:none;">
                <div class="section-title">‚úÖ CHECKLIST RESULT</div>
                <div class="checklist-grid" id="checklistItems"></div>
                <div class="section-card" style="margin-top:8px;" id="scanSummaryCard">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:13px; font-weight:700;">Safety Score</span>
                        <span class="mono green" id="safetyScore" style="font-size:20px; font-weight:700;">16/20</span>
                    </div>
                    <div style="margin-top:8px; background:var(--bg); border-radius:20px; height:6px; overflow:hidden;">
                        <div id="safetyBar" style="height:100%; width:80%;
                            background:linear-gradient(90deg,var(--green),#00c8a0); border-radius:20px;"></div>
                    </div>
                </div>
            </div>

            <div>
                <div class="section-title">üìã RECENT SCANS</div>
                <div id="recentScans" class="checklist-grid">
                    <div style="font-size:12px; color:var(--muted); text-align:center; padding:20px 0;">
                        Koi scan nahi hua abhi
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let currentMode = 'paper';
let sessionId = null;
let recentScans = [];

async function initSession() {
    try {
        const res = await fetch('/init-session', { method: 'POST' });
        const d = await res.json();
        sessionId = d.session_id;
    } catch {
        sessionId = 'session-' + Date.now() + '-' + Math.floor(Math.random() * 99999);
    }
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', ['dashboard','chat','scan'][i] === tab);
    });
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-' + tab).classList.add('active');
    if (tab === 'chat') document.getElementById('chatInput').focus();
}

function setMode(m) {
    currentMode = m;
    document.getElementById('btnPaper').className = 'mode-btn' + (m === 'paper' ? ' active-paper' : '');
    document.getElementById('btnReal').className  = 'mode-btn' + (m === 'real'  ? ' active-real'  : '');
    addMessage(`Mode switched to ${m.toUpperCase()} trading, bhai!`, 'bot');
    switchTab('chat');
}

function addMessage(text, who) {
    const msgs = document.getElementById('messages');
    const row = document.createElement('div');
    row.className = 'msg-row ' + who;
    row.innerHTML = who === 'bot'
        ? `<div class="bubble bot"><div class="bot-name">‚óè MRBLACK</div>${text}</div>`
        : `<div class="bubble user">${text}</div>`;
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
    return row;
}

function addTyping() {
    const msgs = document.getElementById('messages');
    const row = document.createElement('div');
    row.className = 'msg-row bot'; row.id = 'typing-indicator';
    row.innerHTML = `<div class="bubble bot"><div class="bot-name">‚óè MRBLACK</div>
        <div class="typing-dots"><span></span><span></span><span></span></div></div>`;
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    addMessage(text, 'user');
    input.value = '';
    addTyping();
    try {
        const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, session_id: sessionId, user_name: 'Bhai', mode: currentMode })
        });
        const data = await res.json();
        document.getElementById('typing-indicator')?.remove();
        addMessage(data.reply || 'Koi response nahi aaya, bhai.', 'bot');
        if (data.trading) updateStats(data.trading);
    } catch {
        document.getElementById('typing-indicator')?.remove();
        addMessage('‚ö†Ô∏è Network error, bhai! Check connection.', 'bot');
    }
}

function sendSuggestion(text) { document.getElementById('chatInput').value = text; sendMessage(); }
function prefillChat(text) { switchTab('chat'); document.getElementById('chatInput').value = text; document.getElementById('chatInput').focus(); }
function goScan() { switchTab('scan'); }
function scanFromPair(token) { switchTab('scan'); document.getElementById('scanAddr').value = token; }

async function runScan() {
    const addr = document.getElementById('scanAddr').value.trim();
    if (!addr) return;
    document.getElementById('scanResult').style.display = 'none';
    document.querySelector('.scan-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
    try {
        const res = await fetch('/scan', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, session_id: sessionId })
        });
        const data = await res.json();
        renderChecklist(data);
        addToRecentScans(addr, data);
    } catch { alert('Scan failed, bhai. Try again.'); }
    document.querySelector('.scan-btn').innerHTML = '<i class="fas fa-search"></i> Scan Token';
}

function renderChecklist(data) {
    const items = data.checklist || defaultChecklist();
    const passed = items.filter(i => i.status === 'pass').length;
    const total  = items.length;
    const pct    = Math.round((passed / total) * 100);

    document.getElementById('checklistItems').innerHTML = items.map(item => `
        <div class="check-item">
            <div class="check-dot ${item.status}"></div>
            <div class="check-text">${item.label}</div>
            <span class="check-badge badge-${item.status}">${item.value}</span>
        </div>`).join('');

    const scoreColor = pct >= 75 ? 'green' : pct >= 50 ? 'amber' : 'red';
    document.getElementById('safetyScore').className = `mono ${scoreColor}`;
    document.getElementById('safetyScore').textContent = `${passed}/${total}`;
    document.getElementById('safetyBar').style.width = pct + '%';
    document.getElementById('safetyBar').style.background =
        pct >= 75 ? 'linear-gradient(90deg,var(--green),#00c8a0)' :
        pct >= 50 ? 'linear-gradient(90deg,var(--amber),#ff9500)' :
                    'linear-gradient(90deg,var(--red),#ff6b6b)';
    document.getElementById('scanResult').style.display = 'block';
}

function defaultChecklist() {
    return [
        { label: 'Contract Verified',    status: 'pass', value: 'YES'     },
        { label: 'Honeypot Check',        status: 'pass', value: 'SAFE'    },
        { label: 'Liquidity Locked',      status: 'warn', value: '30 DAYS' },
        { label: 'Owner Renounced',       status: 'pass', value: 'YES'     },
        { label: 'Buy Tax',               status: 'pass', value: '3%'      },
        { label: 'Sell Tax',              status: 'warn', value: '7%'      },
        { label: 'Holders > 100',         status: 'pass', value: '842'     },
        { label: 'Top 10 Holders < 30%',  status: 'fail', value: '41%'     },
    ];
}

function addToRecentScans(addr, data) {
    const short = addr.length > 14 ? addr.slice(0, 8) + '...' + addr.slice(-4) : addr;
    recentScans.unshift({ addr: short, full: addr, data });
    if (recentScans.length > 5) recentScans.pop();
    document.getElementById('recentScans').innerHTML = recentScans.map((s, i) => `
        <div class="check-item" onclick="renderChecklist(recentScans[${i}].data)" style="cursor:pointer;">
            <div class="check-dot pass"></div>
            <div class="check-text mono" style="font-size:11px;">${s.addr}</div>
            <span class="check-badge badge-pass">VIEW</span>
        </div>`).join('');
}

function updateStats(d) {
    if (d.paper) document.getElementById('paperBal').textContent = d.paper;
    if (d.real)  document.getElementById('realBal').textContent  = d.real;
    if (d.pnl) {
        document.getElementById('pnlVal').textContent  = d.pnl;
        document.getElementById('pnlVal').className    = 'stat-val ' + (d.pnl.includes('-') ? 'red' : 'green');
    }
}

async function fetchTradingData() {
    try { const res = await fetch('/trading-data'); const data = await res.json(); updateStats(data); } catch {}
}

document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

async function init() {
    await initSession();
    addMessage('Bhai! MrBlack Pro ready hai. Dashboard mein stats dekho, Chat mein poocho, ya Scan karo koi bhi token. üöÄ', 'bot');
    fetchTradingData();
    setInterval(fetchTradingData, 15000);
}
init();
</script>
</body>
</html>
