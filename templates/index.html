<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MrBlack Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg:          #0e0f11;
            --surface:     #161719;
            --card:        #1c1d20;
            --border:      rgba(180,185,200,0.10);
            --border-bright: rgba(180,185,200,0.28);
            --accent:      #c8ccd8;
            --accent-dim:  rgba(200,204,216,0.10);
            --accent-glow: rgba(200,204,216,0.18);
            --green:       #4de8a0;
            --green-dim:   rgba(77,232,160,0.10);
            --red:         #f05068;
            --red-dim:     rgba(240,80,104,0.10);
            --amber:       #e8a830;
            --amber-dim:   rgba(232,168,48,0.10);
            --text:        #dde0ea;
            --muted:       rgba(200,204,216,0.40);
            --subtle:      rgba(200,204,216,0.22);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Syne',sans-serif; background:var(--bg); color:var(--text); height:100dvh; display:flex; flex-direction:column; overflow:hidden; }
        .header { display:flex; align-items:center; justify-content:space-between; padding:12px 18px; background:var(--surface); border-bottom:1px solid var(--border); flex-shrink:0; z-index:20; }
        .header-left { display:flex; align-items:center; gap:10px; }
        .logo-icon { width:34px; height:34px; background:linear-gradient(135deg,#9aa0b4,#c8ccd8); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; color:#0e0f11; letter-spacing:-1px; }
        .brand-name { font-size:17px; font-weight:800; letter-spacing:-0.5px; }
        .live-badge { font-size:9px; background:rgba(77,232,160,0.08); color:var(--green); border:1px solid rgba(77,232,160,0.25); padding:2px 7px; border-radius:20px; font-family:'Space Mono',monospace; }
        .header-right { display:flex; align-items:center; gap:12px; color:var(--muted); }
        .bnb-pill { font-size:11px; font-family:'Space Mono',monospace; color:var(--amber); background:var(--amber-dim); border:1px solid rgba(232,168,48,0.2); padding:3px 10px; border-radius:20px; }
        .tabs { display:flex; background:var(--surface); border-bottom:1px solid var(--border); flex-shrink:0; }
        .tab { flex:1; padding:10px; text-align:center; font-size:12px; font-weight:600; color:var(--muted); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; letter-spacing:0.5px; }
        .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
        .panel { display:none; flex:1; overflow:hidden; flex-direction:column; }
        .panel.active { display:flex; }
        .dashboard-scroll { flex:1; overflow-y:auto; padding:14px; display:flex; flex-direction:column; gap:12px; }
        .dashboard-scroll::-webkit-scrollbar { display:none; }
        .stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
        .stat-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px 10px; text-align:center; }
        .stat-label { font-size:9px; font-family:'Space Mono',monospace; color:var(--muted); letter-spacing:1px; margin-bottom:5px; }
        .stat-val { font-size:15px; font-weight:700; font-family:'Space Mono',monospace; }
        .stat-sub { font-size:9px; color:var(--muted); margin-top:2px; }
        .mode-toggle { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:10px 14px; display:flex; align-items:center; justify-content:space-between; }
        .mode-label { font-size:12px; font-weight:600; color:var(--muted); }
        .toggle-btns { display:flex; gap:6px; }
        .mode-btn { padding:5px 14px; border-radius:8px; font-size:11px; font-weight:700; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Space Mono',monospace; transition:all 0.2s; }
        .mode-btn.active-paper { background:var(--green-dim); color:var(--green); border-color:rgba(77,232,160,0.45); }
        .mode-btn.active-real { background:var(--red-dim); color:var(--red); border-color:rgba(240,80,104,0.45); }
        .section-title { font-size:11px; font-family:'Space Mono',monospace; color:var(--muted); letter-spacing:1.5px; margin-bottom:8px; }
        .section-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px 14px; }
        .pairs-scroll { display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; }
        .pairs-scroll::-webkit-scrollbar { display:none; }
        .pair-chip { flex-shrink:0; background:var(--card); border:1px solid var(--border); border-radius:20px; padding:6px 14px; font-size:11px; font-family:'Space Mono',monospace; white-space:nowrap; cursor:pointer; transition:all 0.15s; color:var(--muted); }
        .pair-chip.hot { border-color:rgba(77,232,160,0.35); color:var(--green); }
        .position-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; }
        .pos-token { font-weight:700; font-size:13px; }
        .pos-meta { font-size:10px; color:var(--muted); margin-top:2px; font-family:'Space Mono',monospace; }
        .pos-pnl { text-align:right; font-family:'Space Mono',monospace; font-weight:700; }
        .pos-pnl .pct { font-size:15px; }
        .pos-pnl .usd { font-size:10px; color:var(--muted); }
        .action-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
        .action-btn { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; font-size:12px; font-weight:700; color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.15s; font-family:'Syne',sans-serif; }
        .action-btn:active { transform:scale(0.97); border-color:var(--accent); }
        .chat-panel { flex:1; display:flex; flex-direction:column; overflow:hidden; }
        .messages { flex:1; overflow-y:auto; padding:14px 14px 8px; display:flex; flex-direction:column; gap:10px; }
        .messages::-webkit-scrollbar { width:3px; }
        .messages::-webkit-scrollbar-thumb { background:var(--subtle); border-radius:10px; }
        .msg-row { display:flex; }
        .msg-row.user { justify-content:flex-end; }
        .msg-row.bot { justify-content:flex-start; }
        .bubble { max-width:82%; padding:10px 14px; font-size:13px; line-height:1.55; border-radius:18px; word-break:break-word; }
        .bubble.user { background:linear-gradient(135deg,#242629,#1c1d20); border:1px solid rgba(180,185,200,0.18); border-bottom-right-radius:5px; }
        .bubble.bot { background:var(--card); border:1px solid var(--border); border-bottom-left-radius:5px; }
        .bot-name { font-size:9px; font-family:'Space Mono',monospace; color:var(--accent); letter-spacing:1px; margin-bottom:4px; opacity:0.7; }
        .typing-dots span { display:inline-block; width:6px; height:6px; background:var(--accent); border-radius:50%; margin:0 2px; animation:bounce 1.2s infinite; opacity:0.5; }
        .typing-dots span:nth-child(2) { animation-delay:0.2s; }
        .typing-dots span:nth-child(3) { animation-delay:0.4s; }
        @keyframes bounce { 0%,60%,100%{transform:translateY(0);opacity:0.35;} 30%{transform:translateY(-5px);opacity:1;} }
        .suggestions { padding:6px 14px; display:flex; gap:6px; overflow-x:auto; flex-shrink:0; }
        .suggestions::-webkit-scrollbar { display:none; }
        .suggestion { flex-shrink:0; background:var(--card); border:1px solid var(--border); border-radius:20px; padding:6px 12px; font-size:11px; cursor:pointer; white-space:nowrap; color:var(--muted); }
        .suggestion:active { border-color:var(--accent); color:var(--accent); }
        .input-bar { padding:10px 14px 12px; background:var(--surface); border-top:1px solid var(--border); flex-shrink:0; }
        .input-row { display:flex; gap:8px; align-items:center; }
        .chat-input { flex:1; background:var(--card); border:1px solid var(--border); border-radius:25px; padding:11px 18px; font-size:13px; color:var(--text); font-family:'Syne',sans-serif; outline:none; transition:border-color 0.2s; }
        .chat-input:focus { border-color:rgba(200,204,216,0.40); }
        .chat-input::placeholder { color:var(--muted); }
        .send-btn { width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,#8b91a8,#c8ccd8); border:none; color:#0e0f11; font-size:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .send-btn:active { transform:scale(0.88); }
        .scan-panel { flex:1; overflow-y:auto; padding:14px; display:flex; flex-direction:column; gap:12px; }
        .scan-panel::-webkit-scrollbar { display:none; }
        .scan-input-wrap { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
        .scan-addr-input { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:11px 14px; font-size:12px; color:var(--text); font-family:'Space Mono',monospace; outline:none; margin-bottom:10px; }
        .scan-btn { width:100%; padding:12px; background:var(--accent-dim); border:1px solid var(--border-bright); border-radius:10px; color:var(--accent); font-size:13px; font-weight:700; cursor:pointer; font-family:'Syne',sans-serif; }
        .checklist-grid { display:flex; flex-direction:column; gap:6px; }
        .check-item { display:flex; align-items:center; gap:10px; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
        .check-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; background:var(--muted); }
        .check-dot.pass { background:var(--green); box-shadow:0 0 6px rgba(77,232,160,0.5); }
        .check-dot.fail { background:var(--red); box-shadow:0 0 6px rgba(240,80,104,0.5); }
        .check-dot.warn { background:var(--amber); }
        .check-text { font-size:12px; flex:1; }
        .check-badge { font-size:9px; font-family:'Space Mono',monospace; padding:2px 7px; border-radius:10px; }
        .badge-pass { background:var(--green-dim); color:var(--green); }
        .badge-fail { background:var(--red-dim); color:var(--red); }
        .badge-warn { background:var(--amber-dim); color:var(--amber); }
        .green { color:var(--green); } .red { color:var(--red); } .amber { color:var(--amber); } .silver { color:var(--accent); }
        .mono { font-family:'Space Mono',monospace; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div class="logo-icon">MB</div>
        <div>
            <span class="brand-name">MrBlack</span>&nbsp;
            <span class="live-badge">&#9679; LIVE</span>
        </div>
    </div>
    <div class="header-right">
        <span class="bnb-pill" id="bnbPill">BNB $--</span>
        <i class="fas fa-bell"></i>
    </div>
</div>

<div class="tabs">
    <div class="tab active" id="tab-dashboard" onclick="switchTab('dashboard')"><i class="fas fa-chart-bar"></i> Dashboard</div>
    <div class="tab" id="tab-chat" onclick="switchTab('chat')"><i class="fas fa-robot"></i> Chat</div>
    <div class="tab" id="tab-scan" onclick="switchTab('scan')"><i class="fas fa-search"></i> Scan</div>
</div>

<!-- DASHBOARD -->
<div class="panel active" id="panel-dashboard">
    <div class="dashboard-scroll">

        <div id="dailyLossWarn" style="display:none;background:var(--red-dim);border:1px solid rgba(240,80,104,0.45);border-radius:12px;padding:10px 14px;font-size:12px;color:var(--red);font-weight:700;text-align:center;">&#128721; DAILY LOSS LIMIT REACHED</div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">PAPER</div>
                <div class="stat-val green" id="paperBal">1.87</div>
                <div class="stat-sub">BNB</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">REAL</div>
                <div class="stat-val red" id="realBal">0.00</div>
                <div class="stat-sub">BNB</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">PNL 24H</div>
                <div class="stat-val green" id="pnlVal">--</div>
                <div class="stat-sub" id="pnlUsd">Loading...</div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">F&amp;G</div>
                <div class="stat-val red" id="fearGreedVal">--</div>
                <div class="stat-sub">/100</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">WIN RATE</div>
                <div class="stat-val amber" id="winRateVal">--</div>
                <div class="stat-sub">% trades</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">TRADES</div>
                <div class="stat-val silver" id="tradeCount">0</div>
                <div class="stat-sub">total</div>
            </div>
        </div>

        <div class="mode-toggle">
            <span class="mode-label">Trading Mode</span>
            <div class="toggle-btns">
                <button class="mode-btn active-paper" id="btnPaper" onclick="setMode('paper')">PAPER</button>
                <button class="mode-btn" id="btnReal" onclick="setMode('real')">REAL</button>
            </div>
        </div>

        <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span class="section-title" style="margin-bottom:0;">&#128315; NEW PAIRS &mdash; BSC</span>
                <span style="font-size:10px;font-family:'Space Mono',monospace;color:var(--green);" id="pairsCount">scanning...</span>
            </div>
            <div class="pairs-scroll" id="pairsRow">
                <div class="pair-chip" style="color:var(--muted);">Scanning BSC...</div>
            </div>
        </div>

        <div>
            <div class="section-title">&#128194; OPEN POSITIONS</div>
            <div class="checklist-grid" id="positionsList">
                <div style="font-size:12px;color:var(--muted);text-align:center;padding:16px 0;">Loading positions...</div>
            </div>
        </div>

        <div class="action-row">
            <button class="action-btn" onclick="switchTab('scan')">
                <span class="silver"><i class="fas fa-search"></i></span> Scan Token
            </button>
            <button class="action-btn" onclick="prefillChat('Market analysis karo')">
                <span class="green"><i class="fas fa-chart-line"></i></span> Analysis
            </button>
            <button class="action-btn" onclick="prefillChat('Meri positions ka status batao')">
                <span class="amber"><i class="fas fa-wallet"></i></span> Status
            </button>
            <button class="action-btn" onclick="prefillChat('Best airdrop opportunities kya hain abhi?')">
                <span class="silver"><i class="fas fa-parachute-box"></i></span> Airdrops
            </button>
        </div>

    </div>
</div>

<!-- CHAT -->
<div class="panel" id="panel-chat">
    <div class="chat-panel">
        <div class="messages" id="messages"></div>
        <div class="suggestions">
            <div class="suggestion" onclick="sendSuggestion('Paper balance kya hai?')">&#128221; Balance</div>
            <div class="suggestion" onclick="sendSuggestion('Market trend kya hai aaj?')">&#128202; Trend</div>
            <div class="suggestion" onclick="sendSuggestion('Kitne learning cycles complete hue?')">&#129504; Learning</div>
            <div class="suggestion" onclick="sendSuggestion('Koi naya BSC token mila?')">&#128315; New Tokens</div>
        </div>
        <div class="input-bar">
            <div class="input-row">
                <input id="chatInput" class="chat-input" type="text" placeholder="Kuch bhi poocho..." autocomplete="off">
                <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- SCAN -->
<div class="panel" id="panel-scan">
    <div class="scan-panel">
        <div class="scan-input-wrap">
            <div class="section-title" style="margin-bottom:10px;">&#128269; TOKEN SCANNER &mdash; 13 STAGE</div>
            <input id="scanAddr" class="scan-addr-input" type="text" placeholder="Contract address 0x... paste karo">
            <button class="scan-btn" id="scanBtn" onclick="runScan()"><i class="fas fa-search"></i> Scan Token</button>
        </div>
        <div id="scanResult" style="display:none;">
            <div class="section-title">CHECKLIST RESULT</div>
            <div class="checklist-grid" id="checklistItems"></div>
            <div class="section-card" style="margin-top:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;font-weight:700;">Safety Score</span>
                    <span class="mono green" id="safetyScore" style="font-size:20px;font-weight:700;">--</span>
                </div>
                <div style="margin-top:8px;background:var(--bg);border-radius:20px;height:6px;overflow:hidden;">
                    <div id="safetyBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--green),#00c8a0);border-radius:20px;transition:width 0.5s;"></div>
                </div>
                <div id="scanRec" style="margin-top:10px;font-size:12px;line-height:1.5;"></div>
            </div>
        </div>
        <div>
            <div class="section-title">&#128203; RECENT SCANS</div>
            <div id="recentScans" class="checklist-grid">
                <div style="font-size:12px;color:var(--muted);text-align:center;padding:20px 0;">Koi scan nahi hua abhi</div>
            </div>
        </div>
    </div>
</div>

<script>
var currentMode = 'paper';
var sessionId   = null;
var recentScans = [];
var lastBnb     = 300;

async function initSession() {
    try {
        var res = await fetch('/init-session', {method: 'POST'});
        var d   = await res.json();
        sessionId = d.session_id;
    } catch(e) {
        sessionId = 'local-' + Date.now();
    }
}

function switchTab(tab) {
    ['dashboard','chat','scan'].forEach(function(t) {
        document.getElementById('tab-' + t).classList.toggle('active', t === tab);
        document.getElementById('panel-' + t).classList.toggle('active', t === tab);
        document.getElementById('panel-' + t).style.display = (t === tab) ? 'flex' : 'none';
    });
    if (tab === 'chat') document.getElementById('chatInput').focus();
}

function setMode(m) {
    currentMode = m;
    document.getElementById('btnPaper').className = 'mode-btn' + (m === 'paper' ? ' active-paper' : '');
    document.getElementById('btnReal').className  = 'mode-btn' + (m === 'real'  ? ' active-real'  : '');
    prefillChat('Mode ' + m.toUpperCase() + ' set kar diya');
}

function addMessage(text, who) {
    var msgs = document.getElementById('messages');
    var row  = document.createElement('div');
    row.className = 'msg-row ' + who;
    if (who === 'bot') {
        row.innerHTML = '<div class="bubble bot"><div class="bot-name">&#9679; MRBLACK</div>' + text + '</div>';
    } else {
        row.innerHTML = '<div class="bubble user">' + text + '</div>';
    }
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
}

function showTyping() {
    var msgs = document.getElementById('messages');
    var row  = document.createElement('div');
    row.className = 'msg-row bot';
    row.id = 'typing';
    row.innerHTML = '<div class="bubble bot"><div class="bot-name">&#9679; MRBLACK</div><div class="typing-dots"><span></span><span></span><span></span></div></div>';
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
}

async function sendMessage() {
    var inp  = document.getElementById('chatInput');
    var text = inp.value.trim();
    if (!text) return;
    addMessage(text, 'user');
    inp.value = '';
    showTyping();
    try {
        var res = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: text, session_id: sessionId, mode: currentMode})
        });
        var d = await res.json();
        var t = document.getElementById('typing');
        if (t) t.remove();
        addMessage(d.reply || 'Response nahi aaya.', 'bot');
        if (d.trading) updateStats(d.trading);
    } catch(e) {
        var t = document.getElementById('typing');
        if (t) t.remove();
        addMessage('Network error, bhai!', 'bot');
    }
}

function sendSuggestion(text) {
    document.getElementById('chatInput').value = text;
    sendMessage();
}

function prefillChat(text) {
    switchTab('chat');
    document.getElementById('chatInput').value = text;
    document.getElementById('chatInput').focus();
}

document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
});

function updateStats(d) {
    if (!d) return;
    if (d.paper) document.getElementById('paperBal').textContent = d.paper;
    if (d.real)  document.getElementById('realBal').textContent  = d.real;
    if (d.pnl) {
        document.getElementById('pnlVal').textContent = d.pnl;
        document.getElementById('pnlVal').className   = 'stat-val ' + (d.pnl.indexOf('-') >= 0 ? 'red' : 'green');
    }
    if (d.paper_usd) { var pu = document.getElementById('pnlUsd'); if (pu) pu.textContent = d.paper_usd; }
    if (d.bnb_price && parseFloat(d.bnb_price) > 0) {
        lastBnb = parseFloat(d.bnb_price);
        var pill = document.getElementById('bnbPill');
        if (pill) pill.textContent = 'BNB $' + lastBnb.toFixed(0);
    }
    if (typeof d.fear_greed !== 'undefined') {
        var fg = document.getElementById('fearGreedVal');
        if (fg) {
            fg.textContent = d.fear_greed;
            fg.className = 'stat-val ' + (d.fear_greed > 60 ? 'green' : d.fear_greed > 40 ? 'amber' : 'red');
        }
    }
    if (typeof d.win_rate !== 'undefined') {
        var wr = document.getElementById('winRateVal');
        if (wr) wr.textContent = d.win_rate + '%';
    }
    if (typeof d.trade_count !== 'undefined') {
        var tc = document.getElementById('tradeCount');
        if (tc) tc.textContent = d.trade_count;
    }
    if (d.limit_reached) {
        var w = document.getElementById('dailyLossWarn');
        if (w) w.style.display = 'block';
    }
    if (d.positions && Array.isArray(d.positions)) renderPositions(d.positions);
}

function renderPositions(positions) {
    var list = document.getElementById('positionsList');
    if (!list) return;
    if (!positions.length) {
        list.innerHTML = '<div style="font-size:12px;color:var(--muted);text-align:center;padding:16px 0;">Koi open position nahi hai abhi</div>';
        return;
    }
    var html = '';
    positions.forEach(function(pos) {
        var pnl   = parseFloat(pos.pnl_pct || 0);
        var color = pnl >= 0 ? 'green' : 'red';
        var sign  = pnl >= 0 ? '+' : '';
        var usd   = Math.abs((pos.size_bnb || 0) * pnl / 100 * lastBnb).toFixed(2);
        html += '<div class="position-card">'
            + '<div><div class="pos-token">' + (pos.token || 'Token') + '</div>'
            + '<div class="pos-meta">Entry: ' + (pos.entry_price || '--') + ' &middot; ' + (pos.size_bnb || '--') + ' BNB</div></div>'
            + '<div class="pos-pnl"><div class="pct ' + color + '">' + sign + pnl.toFixed(1) + '%</div>'
            + '<div class="usd">' + (pnl >= 0 ? '+' : '-') + '$' + usd + '</div></div></div>';
    });
    list.innerHTML = html;
}

async function fetchTradingData() {
    try {
        var res = await fetch('/trading-data');
        var d   = await res.json();
        updateStats(d);
    } catch(e) {}
}

async function fetchNewPairs() {
    try {
        var res   = await fetch('/new-pairs');
        var d     = await res.json();
        var pc    = document.getElementById('pairsCount');
        if (pc) pc.textContent = (d.count || 0) + ' found';
        var row   = document.getElementById('pairsRow');
        if (!row) return;
        var pairs = (d.pairs || []).slice(-6).reverse();
        if (!pairs.length) {
            row.innerHTML = '<div class="pair-chip" style="color:var(--muted);">Abhi koi naya pair nahi mila</div>';
            return;
        }
        var html = '';
        pairs.forEach(function(p) {
            var addr  = p.address || '';
            var short = addr.length > 10 ? addr.slice(0,6) + '...' + addr.slice(-4) : addr;
            html += '<div class="pair-chip hot" onclick="setScanAddr(\'' + addr + '\')">' + short + '</div>';
        });
        row.innerHTML = html;
    } catch(e) {}
}

function setScanAddr(addr) {
    document.getElementById('scanAddr').value = addr;
    switchTab('scan');
}

async function runScan() {
    var addr = document.getElementById('scanAddr').value.trim();
    if (!addr) return;
    document.getElementById('scanResult').style.display = 'none';
    var btn = document.getElementById('scanBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
    try {
        var res = await fetch('/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({address: addr, session_id: sessionId})
        });
        var d = await res.json();
        renderChecklist(d);
        addToRecentScans(addr, d);
    } catch(e) { alert('Scan failed, bhai.'); }
    btn.innerHTML = '<i class="fas fa-search"></i> Scan Token';
}

function renderChecklist(data) {
    var items  = data.checklist || [];
    var passed = 0;
    items.forEach(function(i) { if (i.status === 'pass') passed++; });
    var total = items.length;
    var pct   = total > 0 ? Math.round(passed / total * 100) : 0;
    var html  = '';
    items.forEach(function(item) {
        html += '<div class="check-item">'
            + '<div class="check-dot ' + item.status + '"></div>'
            + '<div class="check-text">' + item.label + '</div>'
            + '<span class="check-badge badge-' + item.status + '">' + item.value + '</span>'
            + '</div>';
    });
    document.getElementById('checklistItems').innerHTML = html;
    var color = pct >= 75 ? 'green' : pct >= 50 ? 'amber' : 'red';
    document.getElementById('safetyScore').className   = 'mono ' + color;
    document.getElementById('safetyScore').textContent = passed + '/' + total;
    document.getElementById('safetyBar').style.width   = pct + '%';
    var rec = document.getElementById('scanRec');
    if (rec && data.recommendation) rec.textContent = data.recommendation;
    document.getElementById('scanResult').style.display = 'block';
}

function addToRecentScans(addr, data) {
    var short = addr.length > 14 ? addr.slice(0,8) + '...' + addr.slice(-4) : addr;
    recentScans.unshift({addr: short, data: data});
    if (recentScans.length > 5) recentScans.pop();
    var html = '';
    recentScans.forEach(function(s, i) {
        html += '<div class="check-item" onclick="renderChecklist(recentScans[' + i + '].data)" style="cursor:pointer;">'
            + '<div class="check-dot pass"></div>'
            + '<div class="check-text mono" style="font-size:11px;">' + s.addr + '</div>'
            + '<span class="check-badge badge-pass">VIEW</span></div>';
    });
    document.getElementById('recentScans').innerHTML = html;
}

async function init() {
    await initSession();
    addMessage('Bhai! MrBlack Pro ready hai. Dashboard mein stats dekho, Chat mein poocho, ya Scan karo koi bhi token. &#128640;', 'bot');
    fetchTradingData();
    fetchNewPairs();
    setInterval(fetchTradingData, 15000);
    setInterval(fetchNewPairs, 30000);
}

init();
</script>
</body>
</html>
